<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!--<!DOCTYPE HTML>-->
  <head>
    <title>RouteFinder, dojo implementation</title>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="js/dojo/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true, debugAtAllCosts: true">
    </script>
    <script>
      
      // register so dojo can find the routeFinder module, takes a path relative to the dojo.js file
      dojo.registerModulePath('routeFinder', '../../routeFinder');
      dojo.require('routeFinder.layer');
      dojo.require('dijit.layout.TabContainer');
      dojo.require('dijit.layout.ContentPane');
      
      dojo.addOnLoad(function(){
      
        dojo.connect(startLocationHolderWidget, 'onDrop', function(source, nodes){
          startingNode = dijit.getEnclosingWidget(nodes[0]);
        });
        
        dojo.connect(dojo.byId('getRouteButton'), 'click', function(evt){
        
          if (!startingNode) {
            console.error('no starting node');
            return;
          }
          
          var numberOfRoutes = dojo.byId('numberOfRoutes').value;
          var router = new routeFinder.Router({
            numberOfRoutes: numberOfRoutes
          });
          router.orderLocations(dijit.registry.byClass('routeFinder.Location'), startingNode, function(route){
            var routeArray = router.splitRoute(route, dojo.byId('numberOfRoutes').value);
            var tabContainer = new dijit.layout.TabContainer();
            for (var i = 0; i < routeArray.length; i++) {
			  
			  tabContainer.addChild(new dijit.layout.ContentPane({			  	
                title: 'Route ' + (i + 1),
                content: '<div id="' + this.id + '_routeContainer">map here</div>',
                onLoad: function(evt){
                  console.log('content pane loaded: ', arguments);
                  console.log('continued: ' + this.id);
                  
                  var map = new routeFinder.Map(route);
                  map.placeAt(this.id + '_routeContainer');
                  map.startup();
                  
                }
              }));
            }
            tabContainer.placeAt('routeTabs');
            tabContainer.startup();
          });
        });
        
        dojo.byId('addressInput').focus();
        
        dojo.connect(dojo.byId('b'), 'onclick', function(){
          dojo.publish(routeFinder.topics.onAddressAdded, ['17129 E Kent Dr, Aurora, CO, 80013']);
        });
        
        
        // throw some default addresses on there
        dojo.attr('addressInput', 'value', '4254 S Biscay Cir, 80013\r\n18351 E Hampden Pl, 80013\r\n16983 E Ithaca Cir, 80013\r\n16968 E Kent Dr, 80013\r\n19291 E Quincy Ave, 80013\r\n17806 E Loyola Dr, 80013\r\n');
      });
    </script>
    <style type='text/css'>
      .container {
          width: 200px;
          height: 200px;
          outline: 1px dashed gray;
      }
      
      .mapContainer {
          position: relative;
          height: 300px;
          width: 500px;
      }
    </style>
  </head>
  <body class="claro">
    <p>
      <label for="numberOfRoutes">
        Number of Routes
      </label>
      <input type="text" id="numberOfRoutes" name="numberOfRoutes" value="1">
    </p>
    <p>
      <label for="addressInput">
        Address(es):
      </label>
      <textarea id="addressInput" name="addressInput">
      </textarea>
    </p>
    <input id="addAddressButton" type="button" value="Add" /><input id='b' type="button" value="drop a hardcoded address" />
    <div>
      <input id="getRouteButton" type="button" value="Get Route" />
      <div id="startLocationHolder" dojotype="dojo.dnd.Source" class="container" jsid="startLocationHolderWidget">
        <span id="startLocationPromptMessage">Drag Start Location Here</span>
      </div>
      <div id="locationHolder" dojotype="dojo.dnd.Source" class="container" autosync="true" jsid="locationHolderWidget">
        <!--        <div dojoType="routeFinder.LocationWidget" unformattedAddress="1770 Carlin St Reno NV" class="dojoDndItem">
        </div>-->
      </div>
      <div id="routeTabs">
      </div>
    </div>
  </body>
</html>
