<!DOCTYPE HTML>
<html>
  <head>
    <title>RouteFinder, dojo implementation</title>
    <link rel="stylesheet" href="styles/main.css" />
    <script src='js/dojo/dojo/dojo.js' djConfig="parseOnLoad: true ">
    </script>
    <script>
      
      // register so dojo can find the routeFinder module, takes a path relative to the dojo.js file
      dojo.registerModulePath('routeFinder', '../../routeFinder');
      dojo.require('routeFinder.layer');
      
      dojo.addOnLoad(function(){
      
        dojo.connect(startLocationHolderWidget, 'onDrop', function(source, nodes){
          startingNode = dijit.getEnclosingWidget(nodes[0]);
        });
        
        dojo.connect(dojo.byId('getRouteButton'), 'click', function(evt){
        
          if (!startingNode) {
            console.error('no starting node');
            return;
          }
          var router = new routeFinder.routing.Router();
          router.orderLocations(dijit.registry.byClass('routeFinder.LocationWidget'), startingNode, function(route){
            //console.log('in callback', route);
            
            // create map and place on the page
            var unformattedMarker = '&markers=label:${0}|${1},${2}';
            var markersValue = '';
			var unformattedPath = '|${0},${1}';
			var pathsValue = '';
            
            dojo.forEach(route.orderedLocations, function(location, index){
              markersValue += dojo.string.substitute(unformattedMarker, [index + 1, location.lat, location.lon]);
			  pathsValue += dojo.string.substitute(unformattedPath, [location.lat, location.lon]);
            });
			
			
			
            //markersValue = markersValue.substring(0, markersValue.length - 1);
            
            //dojo.create('img', {
            //  src: 'http://maps.google.com/maps/api/staticmap?center=39.64,-104.78&zoom=14&size=512x512&maptype=roadmap&sensor=false&path=color:0xff0000ff|weight:5' + pathsValue + markersValue
            //}, 'map');
			var map = new routeFinder.routing.Map({
				route : route
			})
			map.startup();
			map.placeAt('mapContainer');
            
          });
        });
        
        dojo.byId('addressInput').focus();
        
        dojo.connect(dojo.byId('b'), 'onclick', function(){
          dojo.publish(routeFinder.topics.onAddressAdded, ['17129 E Kent Dr, Aurora, CO, 80013']);
        });
        
        
        dojo.attr('addressInput', 'value', '4254 S Biscay Cir, 80013\r\n18351 E Hampden Pl, 80013\r\n16983 E Ithaca Cir, 80013\r\n16968 E Kent Dr, 80013\r\n19291 E Quincy Ave, 80013\r\n17806 E Loyola Dr, 80013\r\n');
      });
    </script>
    <style type='text/css'>
      .container {
          width: 200px;
          height: 200px;
          outline: 1px dashed gray;
      }
    </style>
  </head>
  <body class="claro">
    <div>
      <textarea id="addressInput">
        17129 E Kent Dr 80013
        909 S Broadway 76058
        7275 S Broadway Littleton, CO
      </textarea>
    </div>
    <input id="addAddressButton" type="button" value="Add" /><input id='b' type="button" value="drop a hardcoded address" />
    <div>
      <input id="getRouteButton" type="button" value="Get Route" />
      <div id="startLocationHolder" dojotype="dojo.dnd.Source" class="container" jsid="startLocationHolderWidget">
        <span id="startLocationPromptMessage">Drag Start Location Here</span>
      </div>
      <div id="locationHolder" dojotype="dojo.dnd.Source" class="container" autosync="true" jsid="locationHolderWidget">
        <!--        <div dojoType="routeFinder.LocationWidget" unformattedAddress="1770 Carlin St Reno NV" class="dojoDndItem">
        </div>-->
      </div>
	  <div id="mapContainer"></div>
    </div>
  </body>
</html>
